---
import BaseLayout from '../../layouts/BaseLayout.astro';
import SeoHead from '../../layouts/SeoHead.astro';
import ServicePillarPage from '../../templates/ServicePillarPage.astro';
import LocationPage from '../../templates/LocationPage.astro';
import ServiceSecondaryPage from '../../templates/ServiceSecondaryPage.astro';
import PricingPage from '../../templates/PricingPage.astro';
import ContactPage from '../../templates/ContactPage.astro';
import { siteConfig } from '../../config/site';

const contentModules = import.meta.glob('../../content/sites/*/*/*/content.json');
const seoModules = import.meta.glob('../../content/sites/*/*/*/seo.json');

export async function getStaticPaths() {
  const siteId = siteConfig.siteId || 'ecofundrive';
  const entries: { params: { lang: string; slug: string } }[] = [];

  for (const filePath in contentModules) {
    const segments = filePath.split('/');
    const sitesIndex = segments.indexOf('sites');
    if (sitesIndex === -1) continue;

    const currentSiteId = segments[sitesIndex + 1];
    const lang = segments[sitesIndex + 2];
    const slug = segments[sitesIndex + 3];

    if (currentSiteId === siteId) {
      entries.push({ params: { lang, slug } });
    }
  }

  return entries;
}

const { lang, slug } = Astro.params;
const siteId = siteConfig.siteId || 'ecofundrive';

let content: any = null;
let seo: any = null;
let template: string = 'service_pillar';

if (lang && slug) {
  const contentKey = `../../content/sites/${siteId}/${lang}/${slug}/content.json`;
  const seoKey = `../../content/sites/${siteId}/${lang}/${slug}/seo.json`;

  if (contentModules[contentKey]) {
    const mod: any = await (contentModules[contentKey] as any)();
    content = mod.default;
    if (content && typeof content.template === 'string') {
      template = content.template;
    }
  }

  if (seoModules[seoKey]) {
    const seoMod: any = await (seoModules[seoKey] as any)();
    seo = seoMod.default;
  }
}

let PageTemplate = ServicePillarPage;
if (template === 'location') {
  PageTemplate = LocationPage;
} else if (template === 'service_secondary') {
  PageTemplate = ServiceSecondaryPage;
} else if (template === 'pricing') {
  PageTemplate = PricingPage;
} else if (template === 'contact') {
  PageTemplate = ContactPage;
}

const pageTitle = content?.meta_title || 'Page générée';
const pageDescription = content?.meta_description || '';
---

<BaseLayout lang={lang || 'fr'}>
  <SeoHead slot="head" title={pageTitle} description={pageDescription} />
  {content?.base_css && (
    <style slot="head" set:html={content.base_css}></style>
  )}
  {content ? (
    <PageTemplate content={content} seo={seo} />
  ) : (
    <main>
      <h1>Page non trouvée</h1>
      <p>Le contenu généré pour cette URL est introuvable ou pas encore disponible.</p>
    </main>
  )}
</BaseLayout>
